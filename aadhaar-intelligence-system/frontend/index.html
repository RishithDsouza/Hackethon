<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Aadhaar Intelligence System â€“ Advanced Analytics</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
/* ---------- BASE ---------- */
body {
    font-family: "Segoe UI", Arial, sans-serif;
    background: #f4f6f8;
    color: #111;
    padding: 30px;
    transition: 0.3s;
}
h1 { text-align:center; }

/* ---------- FILTER ---------- */
.filter-bar {
    display:flex;
    justify-content:center;
    gap:20px;
    margin:20px 0;
}
select, button {
    padding:8px 12px;
    border-radius:8px;
    border:1px solid #ccc;
}

/* ---------- GRID ---------- */
.grid {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
    gap:20px;
    margin-top:30px;
}

/* ---------- CARDS ---------- */
.card {
    background:#fff;
    padding:20px;
    border-radius:14px;
    box-shadow:0 8px 24px rgba(0,0,0,.15);
}

/* ---------- GLASS ---------- */
.glass {
    background: rgba(255,255,255,0.7);
    backdrop-filter: blur(12px);
    cursor:pointer;
    transition:.25s;
    cursor: zoom-in;
}
.glass:hover { transform: scale(1.03); }

/* ---------- MAP ---------- */
#map { height:420px; border-radius:10px; }

/* ---------- MODAL ---------- */
.modal {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.7);
    z-index:9999;
}
.modal-content {
    background:#fff;
    width:90%;
    height:85%;
    margin:3% auto;
    border-radius:16px;
    padding:20px;
    position:relative;
}
.modal-close {
    position:absolute;
    top:10px;
    right:18px;
    font-size:22px;
    cursor:pointer;
}

/* ---------- DARK MODE ---------- */
body.dark {
    background:#0f172a;
    color:#e5e7eb;
}
body.dark .card,
body.dark .glass {
    background: rgba(30,41,59,.85);
    color:#e5e7eb;
}
body.dark select,
body.dark button {
    background:#020617;
    color:#e5e7eb;
    border:1px solid #334155;
}
body.dark .modal-content {
    background:#020617;
}
</style>
</head>

<body>

<h1>Aadhaar Intelligence System â€“ Advanced Data Visualization</h1>

<div class="filter-bar">
    <select id="stateSelect"><option value="">All States</option></select>
    <select id="districtSelect"><option value="">All Districts</option></select>
    <button id="themeToggle">ðŸŒ™ Dark</button>
</div>

<div class="grid">
    <div class="card" id="kpiCard"></div>
    <div class="card" id="summaryCard"></div>
</div>

<div class="grid">
    <div class="card glass" onclick="openChart('barChart')"><canvas id="barChart"></canvas></div>
    <div class="card glass" onclick="openChart('timeChart')"><canvas id="timeChart"></canvas></div>
    <div class="card glass" onclick="openChart('forecastChart')"><canvas id="forecastChart"></canvas></div>
    <div class="card glass" onclick="openChart('loadChart')"><canvas id="loadChart"></canvas></div>
    <div class="card glass" onclick="openChart('pieChart')"><canvas id="pieChart"></canvas></div>
</div>

<div class="grid">
    <div class="card">
        <h3>India Aadhaar Enrolment Heatmap</h3>
        <div id="map"></div>
    </div>
</div>

<div class="grid">
    <div class="card" id="insightsCard"></div>
</div>

<!-- MODAL -->
<div id="chartModal" class="modal" onclick="closeModal(event)">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">âœ–</span>
        <canvas id="modalChart"></canvas>
    </div>
</div>

<script>
const BASE = "http://127.0.0.1:5000";
let map;
let charts = {};
let modalChart = null;
const stateCoords = {
    "karnataka": [15.3, 75.7],
    "tamil nadu": [11.1, 78.6],
    "maharashtra": [19.7, 75.7],
    "telangana": [18.1, 79.0],
    "andhra pradesh": [15.9, 79.7],
    "kerala": [10.8, 76.2],
    "uttar pradesh": [26.8, 80.9],
    "madhya pradesh": [22.9, 78.6],
    "rajasthan": [27.0, 74.2],
    "west bengal": [22.9, 87.8],
    "delhi": [28.6, 77.2]
};

/* ---------- THEME ---------- */
const toggleBtn = document.getElementById("themeToggle");
toggleBtn.onclick = () => {
    document.body.classList.toggle("dark");
    toggleBtn.innerText = document.body.classList.contains("dark") ? "â˜€ï¸ Light" : "ðŸŒ™ Dark";
};
function normalizeState(name) {
    return name
        .toLowerCase()
        .replace(/&/g, "and")
        .replace(/\s+/g, " ")
        .trim();
}
function loadHeatmap() {
    fetch(BASE + "/heatmap-data")
        .then(r => r.json())
        .then(data => {
            const values = Object.values(data);
            const max = Math.max(...values);

            Object.entries(data).forEach(([state, value]) => {
                const key = normalizeState(state);

                if (!stateCoords[key]) {
                    console.warn("Missing coordinates for:", state);
                    return;
                }

                L.circleMarker(stateCoords[key], {
                    radius: 8 + (value / max) * 25,
                    fillColor: "#ef4444",
                    fillOpacity: 0.8,
                    color: "#111",
                    weight: 1
                })
                .addTo(map)
                .bindPopup(`
                    <b>${state}</b><br>
                    Total Enrolments: ${value.toLocaleString()}
                `);
            });
        });
}


/* ---------- HELPERS ---------- */
function q(){
    let s=stateSelect.value,d=districtSelect.value,a=[];
    if(s)a.push("state="+s);
    if(d)a.push("district="+d);
    return a.length?"?"+a.join("&"):"";
}
function draw(id,type,data,labels,label){
    if(charts[id]) charts[id].destroy();
    charts[id] = new Chart(document.getElementById(id),{
        type,
        data:{ labels, datasets:[{ label, data }] },
        options:{ responsive:true }
    });
}

/* ---------- LOAD ---------- */
function load(){
    fetch(BASE+"/kpis"+q()).then(r=>r.json()).then(d=>{
        kpiCard.innerHTML = `<h3>KPIs</h3><b>${d.avg_daily_enrolments}</b><br>Failure: ${d.failure_rate}%<br>Load: ${d.avg_service_load}`;
    });

    fetch(BASE+"/summary"+q()).then(r=>r.json()).then(d=>{
        summaryCard.innerHTML = `<h3>Summary</h3>Enrolments: ${d.total_enrolments}<br>Updates: ${d.total_updates}<br>Failures: ${d.total_failures}`;
    });

    fetch(BASE+"/bar-data"+q()).then(r=>r.json()).then(d=>draw("barChart","bar",Object.values(d),Object.keys(d),"Enrolments"));
    fetch(BASE+"/timeseries"+q()).then(r=>r.json()).then(d=>draw("timeChart","line",d.values,d.dates,"Trend"));
    fetch(BASE+"/service-load"+q()).then(r=>r.json()).then(d=>draw("loadChart","line",d.values,d.dates,"Service Load"));
    fetch(BASE+"/distribution"+q()).then(r=>r.json()).then(d=>draw("pieChart","pie",[d.enrolments,d.updates],["Enrolments","Updates"],"Workload"));
    fetch(BASE+"/forecast"+q()).then(r=>r.json()).then(d=>{
        if(!d.dates.length) return;
        draw("forecastChart","line",d.forecast,d.dates,"Forecast");
    });
    fetch(BASE+"/insights"+q()).then(r=>r.json()).then(list=>{
        insightsCard.innerHTML = "<h3>Insights</h3><ul>"+list.map(i=>"<li>"+i+"</li>").join("")+"</ul>";
    });
}

/* ---------- MODAL ---------- */
function openChart(id){
    const orig = charts[id];
    if(!orig) return;
    const ctx = document.getElementById("modalChart").getContext("2d");
    if(modalChart) modalChart.destroy();
    modalChart = new Chart(ctx,{
        type:orig.config.type,
        data:JSON.parse(JSON.stringify(orig.config.data)),
        options:{ responsive:true }
    });
    chartModal.style.display="block";
}
function closeModal(e){
    if(!e || e.target.id==="chartModal"){
        chartModal.style.display="none";
        if(modalChart) modalChart.destroy();
    }
}

/* ---------- INIT ---------- */
fetch(BASE+"/bar-data").then(r=>r.json()).then(d=>{
    Object.keys(d).forEach(s=>stateSelect.innerHTML+=`<option>${s}</option>`);
});
stateSelect.onchange=()=>{districtSelect.innerHTML="<option>All</option>";load();};
districtSelect.onchange=load;
load();
window.onload = () => {
    map = L.map('map').setView([22.5, 78.9], 5);

    L.tileLayer(
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { attribution: 'Â© OpenStreetMap contributors' }
    ).addTo(map);

    loadHeatmap();   // ðŸ”¥ VERY IMPORTANT
};

</script>

</body>
</html>
